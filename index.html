<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroNexo - Gesti칩n Inteligente</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --primary: #0f172a;   /* Azul oscuro */
            --secondary: #334155; /* Gris azulado */
            --accent: #16a34a;    /* Verde Agro */
            --bg: #f1f5f9;        /* Fondo claro */
            --text: #1e293b;      /* Texto */
        }
        
        * { box-sizing: border_box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background: var(--bg); display: flex; height: 100vh; overflow: hidden; }

        /* --- SIDEBAR --- */
        .sidebar { width: 260px; background: var(--primary); color: white; display: flex; flex-direction: column; padding: 20px; transition: 0.3s; flex-shrink: 0; }
        .logo { font-size: 24px; font-weight: bold; color: var(--accent); margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .menu-label { font-size: 12px; text-transform: uppercase; color: #94a3b8; margin-bottom: 10px; font-weight: bold; letter-spacing: 1px; }
        
        .nav-btn {
            background: transparent; border: none; color: #cbd5e1; width: 100%; padding: 14px; text-align: left;
            font-size: 15px; cursor: pointer; border-radius: 8px; display: flex; align-items: center; gap: 12px;
            transition: 0.2s; margin-bottom: 5px;
        }
        .nav-btn:hover, .nav-btn.active { background: var(--secondary); color: white; border-left: 4px solid var(--accent); }
        .nav-btn i { width: 20px; text-align: center; }

        /* --- CONTENIDO PRINCIPAL --- */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { color: var(--text); font-size: 26px; }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .online { background: #dcfce7; color: #166534; }
        .offline { background: #fee2e2; color: #991b1b; }

        /* --- VISTAS (PANELES) --- */
        .view { display: none; animation: fadeUpdate 0.3s; }
        .view.active { display: block; }

        /* Dashboard Cards */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
        .card::before { content: ''; position: absolute; top: 0; left: 0; width: 5px; height: 100%; background: var(--accent); }
        .card h3 { color: #64748b; font-size: 14px; text-transform: uppercase; margin-bottom: 5px; }
        .card .value { font-size: 32px; font-weight: 700; color: var(--text); }
        .card .icon-bg { position: absolute; right: 20px; bottom: 20px; font-size: 40px; opacity: 0.1; color: var(--text); }

        /* Tablas */
        .table-container { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; }
        .toolbar { padding: 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .btn-primary { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .btn-primary:hover { background: #15803d; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; text-align: left; padding: 15px; color: #64748b; font-size: 13px; font-weight: 600; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid #e2e8f0; color: var(--text); }
        tr:last-child td { border-bottom: none; }
        
        /* Mapa */
        #map-container { height: 500px; width: 100%; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1; }

        /* Modal Simple */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: white; padding: 30px; border-radius: 12px; width: 400px; max-width: 90%; }
        .modal h2 { margin-bottom: 20px; color: var(--text); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 14px; color: #64748b; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .btn-cancel { background: #e2e8f0; color: #475569; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }

        @keyframes fadeUpdate { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo"><i class="fas fa-leaf"></i> AgroNexo</div>
        
        <div class="menu-label">Principal</div>
        <button class="nav-btn active" onclick="showView('dashboard')"><i class="fas fa-home"></i> Resumen</button>
        <button class="nav-btn" onclick="showView('mapa')"><i class="fas fa-map-marked-alt"></i> Mapa General</button>
        
        <div class="menu-label" style="margin-top: 20px;">Gesti칩n</div>
        <button class="nav-btn" onclick="showView('ganaderia')"><i class="fas fa-cow"></i> Ganader칤a</button>
        <button class="nav-btn" onclick="showView('agricultura')"><i class="fas fa-tractor"></i> Agricultura</button>
        
        <div style="margin-top: auto;">
             <a href="https://agronexo-backend.onrender.com/reset" target="_blank" class="nav-btn" style="color: #ef4444;"><i class="fas fa-redo"></i> Resetear Datos</a>
        </div>
    </div>

    <div class="main-content">
        
        <div class="header">
            <h1 id="page-title">Panel de Control</h1>
            <span id="connection-status" class="status-badge offline">Conectando...</span>
        </div>

        <div id="dashboard" class="view active">
            <div class="grid">
                <div class="card">
                    <h3>Hacienda Total</h3>
                    <div class="value" id="dash-animales">--</div>
                    <i class="fas fa-cow icon-bg"></i>
                </div>
                <div class="card" style="border-left-color: #eab308;"> <h3>Lotes Activos</h3>
                    <div class="value" id="dash-lotes">--</div>
                    <i class="fas fa-seedling icon-bg"></i>
                </div>
                <div class="card" style="border-left-color: #3b82f6;"> <h3>Margen Bruto</h3>
                    <div class="value">$ 4.5M</div>
                    <i class="fas fa-chart-line icon-bg"></i>
                </div>
            </div>
            
            <div class="card">
                <h3>Actividad Reciente</h3>
                <p style="color: #64748b; margin-top: 10px;">Sistema restaurado y conectado correctamente. Base de datos operativa.</p>
            </div>
        </div>

        <div id="ganaderia" class="view">
            <div class="table-container">
                <div class="toolbar">
                    <h2>Inventario Animal</h2>
                    <button class="btn-primary" onclick="openModal('modal-animal')"><i class="fas fa-plus"></i> Nuevo Animal</button>
                </div>
                <table>
                    <thead><tr><th>Caravana</th><th>Categor칤a</th><th>Estado</th><th>Ubicaci칩n (Lat/Lng)</th></tr></thead>
                    <tbody id="table-ganaderia"><tr><td colspan="4">Cargando...</td></tr></tbody>
                </table>
            </div>
        </div>

        <div id="agricultura" class="view">
            <div class="table-container">
                <div class="toolbar">
                    <h2>Lotes Productivos</h2>
                    <button class="btn-primary" onclick="openModal('modal-lote')"><i class="fas fa-plus"></i> Nuevo Lote</button>
                </div>
                <table>
                    <thead><tr><th>Nombre</th><th>Cultivo</th><th>Has</th><th>Estado</th></tr></thead>
                    <tbody id="table-agricultura"><tr><td colspan="4">Cargando...</td></tr></tbody>
                </table>
            </div>
        </div>

        <div id="mapa" class="view">
            <div id="map-container"></div>
            <p style="margin-top: 10px; color: #64748b; font-size: 14px;">* Mostrando ubicaci칩n en tiempo real de lotes y animales.</p>
        </div>

    </div>

    <div id="modal-animal" class="modal-overlay">
        <div class="modal">
            <h2>Registrar Animal</h2>
            <div class="form-group">
                <label>Caravana / ID</label>
                <input type="text" id="new-caravana" placeholder="Ej: V-204">
            </div>
            <div class="form-group">
                <label>Categor칤a</label>
                <select id="new-categoria">
                    <option value="Vaca">Vaca</option>
                    <option value="Vaquillona">Vaquillona</option>
                    <option value="Ternero">Ternero</option>
                    <option value="Toro">Toro</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal('modal-animal')">Cancelar</button>
                <button class="btn-primary" onclick="guardarAnimal()">Guardar</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // CONFIGURACI칍N
        const API_URL = "https://agronexo-backend.onrender.com";
        let map = null;

        // INICIALIZACI칍N
        document.addEventListener('DOMContentLoaded', () => {
            checkStatus();
            loadResumen();
        });

        // NAVEGACI칍N
        function showView(viewId) {
            // UI
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // T칤tulo
            const titles = { 'dashboard': 'Resumen', 'ganaderia': 'Ganader칤a', 'agricultura': 'Agricultura', 'mapa': 'Mapa Satelital' };
            document.getElementById('page-title').innerText = titles[viewId];

            // Cargar datos espec칤ficos
            if(viewId === 'ganaderia') loadGanaderia();
            if(viewId === 'agricultura') loadAgricultura();
            if(viewId === 'mapa') initMap();
        }

        // API & DATOS
        async function checkStatus() {
            const badge = document.getElementById('connection-status');
            try {
                await fetch(`${API_URL}/`);
                badge.innerText = "ONLINE 游릭";
                badge.className = "status-badge online";
            } catch (e) {
                badge.innerText = "OFFLINE 游댮";
                badge.className = "status-badge offline";
            }
        }

        async function loadResumen() {
            try {
                const res = await fetch(`${API_URL}/api/resumen`);
                const data = await res.json();
                document.getElementById('dash-animales').innerText = data.animales;
                document.getElementById('dash-lotes').innerText = data.lotes;
            } catch(e) { console.error(e); }
        }

        async function loadGanaderia() {
            const tbody = document.getElementById('table-ganaderia');
            tbody.innerHTML = '<tr><td colspan="4">Actualizando...</td></tr>';
            try {
                const res = await fetch(`${API_URL}/api/ganaderia`);
                const data = await res.json();
                tbody.innerHTML = '';
                data.forEach(a => {
                    tbody.innerHTML += `<tr>
                        <td><b>${a.caravana}</b></td>
                        <td>${a.categoria}</td>
                        <td><span style="color:${a.estado==='PRE칌ADA'?'green':'#64748b'}">${a.estado}</span></td>
                        <td>${a.lat.toFixed(4)}, ${a.lng.toFixed(4)}</td>
                    </tr>`;
                });
            } catch(e) { tbody.innerHTML = '<tr><td colspan="4">Error cargando datos</td></tr>'; }
        }
        
        async function loadAgricultura() {
            const tbody = document.getElementById('table-agricultura');
            try {
                const res = await fetch(`${API_URL}/api/agricultura`);
                const data = await res.json();
                tbody.innerHTML = '';
                data.forEach(l => {
                    tbody.innerHTML += `<tr><td><b>${l.nombre}</b></td><td>${l.cultivo}</td><td>${l.hectareas} Has</td><td>Activo</td></tr>`;
                });
            } catch(e) {}
        }

        // MAPA LEAFLET
        async function initMap() {
            if(map) { map.remove(); } // Reset mapa si ya exist칤a
            
            // Coordenadas base (Chaco aprox)
            map = L.map('map-container').setView([-26.70, -60.80], 14);
            
            // Capa Satelital (Esri World Imagery)
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri'
            }).addTo(map);

            // Cargar Puntos
            try {
                const res = await fetch(`${API_URL}/api/mapa`);
                const puntos = await res.json();
                
                puntos.forEach(p => {
                    let color = p.color === 'red' ? '#ef4444' : (p.color === 'green' ? '#22c55e' : '#3b82f6');
                    
                    // Marcador Circular Personalizado
                    const markerHtml = `<div style="background:${color}; width:15px; height:15px; border-radius:50%; border:2px solid white; box-shadow:0 0 5px black;"></div>`;
                    const icon = L.divIcon({ html: markerHtml, className: 'custom-marker' });

                    L.marker([p.lat, p.lng], {icon: icon})
                     .addTo(map)
                     .bindPopup(`<b>${p.titulo}</b><br>${p.desc}`);
                });
            } catch(e) { console.error("Error mapa", e); }
        }

        // FUNCIONES MODAL
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        async function guardarAnimal() {
            const caravana = document.getElementById('new-caravana').value;
            const categoria = document.getElementById('new-categoria').value;
            
            if(!caravana) return alert("Falta Caravana");

            const btn = event.target;
            btn.innerText = "Guardando...";
            
            try {
                await fetch(`${API_URL}/api/ganaderia`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        caravana: caravana,
                        categoria: categoria,
                        estado: "VACIA",
                        lat: -26.7 + (Math.random()/100), // Ubicaci칩n aleatoria cercana
                        lng: -60.8 + (Math.random()/100)
                    })
                });
                closeModal('modal-animal');
                loadGanaderia(); // Recargar tabla
                btn.innerText = "Guardar";
                document.getElementById('new-caravana').value = "";
            } catch(e) { alert("Error guardando"); }
        }
    </script>
</body>
</html>
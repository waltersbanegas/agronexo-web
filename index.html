<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgroNexo ERP Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --p: #0f172a; --a: #22c55e; --bg: #f8fafc; --red: #ef4444; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',sans-serif; }
        body { background:var(--bg); display:flex; height:100vh; overflow:hidden; }
        .sidebar { width:260px; background:var(--p); color:white; padding:15px; display:flex; flex-direction:column; z-index:1000; }
        .logo { font-size:22px; font-weight:bold; color:var(--a); margin-bottom:30px; }
        .nav-btn { background:none; border:none; color:#cbd5e1; width:100%; padding:12px; text-align:left; cursor:pointer; display:flex; gap:12px; border-radius:8px; margin-bottom:5px; align-items:center; }
        .nav-btn.active, .nav-btn:hover { background:#334155; color:white; border-left:4px solid var(--a); }
        .main { flex:1; overflow-y:auto; padding:20px; position:relative; }
        .view { display:none; }
        .view.active { display:block; animation:fadeIn 0.3s; }
        .grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:20px; margin-bottom:20px; }
        .card { background:white; padding:25px; border-radius:12px; border-top:5px solid var(--a); box-shadow:0 4px 6px rgba(0,0,0,0.05); }
        .card .val { font-size:32px; font-weight:bold; color:var(--p); }
        #map { width:100%; height:65vh; border-radius:12px; }
        @media (max-width:768px) { body{flex-direction:column;} .sidebar{width:100%; height:auto; flex-direction:row; overflow-x:auto;} .logo{display:none;} }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="logo">AgroNexo Pro</div>
    <button class="nav-btn active" onclick="go('dash')"><i class="fas fa-chart-line"></i> Dashboard</button>
    <button class="nav-btn" onclick="go('mapa')"><i class="fas fa-map-marked-alt"></i> Mapa</button>
    <button class="nav-btn" onclick="go('vaca')"><i class="fas fa-cow"></i> Ganadería</button>
    <button class="nav-btn" onclick="go('repo')"><i class="fas fa-file-export"></i> Reportes</button>
    <div style="flex:1"></div>
    <div id="sync-status" style="font-size:11px; padding:10px; color:#aaa;">Sincronizado ✅</div>
</div>

<div class="main">
    <div id="dash" class="view active">
        <div class="grid">
            <div class="card"><h3>Posición de Caja</h3><div class="val" id="k-caja">$ --</div></div>
            <div class="card"><h3>GDP Promedio</h3><div class="val">0.850 kg/d</div></div>
            <div class="card" id="alert-s" style="display:none; border-top-color:var(--red);"><h3>Alertas Stock ⚠️</h3><div class="val" id="k-alert">--</div></div>
        </div>
    </div>

    <div id="mapa" class="view"><div id="map"></div></div>

    <div id="vaca" class="view">
        <div class="card">
            <h2>Manejo Individual (Braford)</h2>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <input id="scan-id" placeholder="ID Caravana..." class="nav-btn" style="border:1px solid #ddd; color:var(--p)">
                <button class="nav-btn" style="background:var(--a); color:white; width:auto;" onclick="pesar()">Registrar Peso</button>
            </div>
        </div>
    </div>

    <div id="repo" class="view">
        <div class="card">
            <h2>Exportar Gestión</h2>
            <div style="margin-top:20px; display:flex; gap:15px;">
                <button class="nav-btn" style="background:#1d6f42; color:white; width:auto;" onclick="expXL()">Excel (.xlsx)</button>
                <button class="nav-btn" style="background:#b91c1c; color:white; width:auto;" onclick="expPDF()">PDF (.pdf)</button>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const API = "https://agronexo-backend.onrender.com";
let map;

// PERSISTENCIA LOCAL
const request = indexedDB.open("AgroNexoDB", 1);
request.onupgradeneeded = e => { e.target.result.createObjectStore("sync", {keyPath:"id", autoIncrement:true}); };

function go(id){ document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); document.getElementById(id).classList.add('active'); if(id==='mapa') setTimeout(initMap,200); }

async function loadDash(){
    const r = await (await fetch(`${API}/api/dashboard/full`)).json();
    document.getElementById('k-caja').innerText = `$ ${r.financiero.caja.toLocaleString()}`;
    if(r.operativo.alertas > 0){ document.getElementById('alert-s').style.display='block'; document.getElementById('k-alert').innerText = r.operativo.alertas; }
}

async function pesar(){
    const id = document.getElementById('scan-id').value;
    const peso = prompt("Peso (kg):");
    const d = { caravana:id, peso:peso };
    if(!navigator.onLine){
        const db = await new Promise(res => { const req = indexedDB.open("AgroNexoDB",1); req.onsuccess = () => res(req.result); });
        db.transaction("sync","readwrite").objectStore("sync").add({type:'PESO', data:d});
        document.getElementById('sync-status').innerText = "Pendiente ⚠️";
    } else {
        await fetch(`${API}/api/ganaderia/pesada`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)});
        alert("Sincronizado ✅"); loadDash();
    }
}

function initMap(){
    if(!map){
        map = L.map('map').setView([-26.42, -61.41], 13);
        L.tileLayer('http://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{maxZoom:20, subdomains:['mt0','mt1','mt2','mt3']}).addTo(map);
    }
    map.invalidateSize();
}

async function expXL(){
    const r = await (await fetch(`${API}/api/reportes/consolidado`)).json();
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(r.hacienda), "Hacienda");
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(r.finanzas), "Finanzas");
    XLSX.writeFile(wb, "AgroNexo_Expert.xlsx");
}

async function expPDF(){
    const { jsPDF } = window.jspdf; const doc = new jsPDF();
    const r = await (await fetch(`${API}/api/reportes/consolidado`)).json();
    doc.text("AgroNexo ERP - Informe Consolidado", 14, 20);
    doc.autoTable({ startY:30, head:[['Fecha','Concepto','Monto']], body: r.finanzas.map(f=>[f.f, f.c, `$ ${f.m}`]) });
    doc.save("AgroNexo_Informe.pdf");
}

window.onload = loadDash;
</script>
</body>
</html>
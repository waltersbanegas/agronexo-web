<!DOCTYPE html>
<html>
<head>
    <title>AgroNexo Master Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .ficha-container { display: grid; grid-template-columns: 300px 1fr; gap: 20px; background: white; padding: 20px; border-radius: 15px; }
        .animal-img { width: 100%; border-radius: 10px; border: 3px solid #22c55e; }
        .stats-card { background: #f8fafc; padding: 15px; border-radius: 10px; margin-top: 10px; border-left: 5px solid #22c55e; }
    </style>
</head>
<body style="background:#f1f5f9; font-family:sans-serif;">

    <div style="max-width: 1000px; margin: auto; padding: 20px;">
        <h1>Dashboard Ganadero</h1>
        
        <div class="ficha-container">
            <div>
                <img id="foto-animal" src="placeholder.jpg" class="animal-img">
                <button onclick="leerNombre()" style="width:100%; margin-top:10px; padding:10px;">
                    <i class="fas fa-volume-up"></i> Escuchar Nombre
                </button>
            </div>
            
            <div id="info-animal">
                <h2 id="disp-nombre">Seleccione un Animal</h2>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="stats-card">Raza: <b id="disp-raza">-</b></div>
                    <div class="stats-card">Estado: <b id="disp-estado">-</b></div>
                    <div class="stats-card">IEP (Días): <b id="disp-iep">-</b></div>
                    <div class="stats-card">Crías Totales: <b id="disp-crias">-</b></div>
                </div>
            </div>
        </div>

        <canvas id="curvaLactancia" style="margin-top:30px; background:white; padding:20px; border-radius:15px;"></canvas>
    </div>

<script>
    const API = "https://agronexo-backend.onrender.com";

    // Audio: Text-to-Speech
    function leerNombre() {
        const nombre = document.getElementById('disp-nombre').innerText;
        const msg = new SpeechSynthesisUtterance(nombre);
        window.speechSynthesis.speak(msg);
    }

    async function cargarFicha(nombre) {
        const res = await fetch(`${API}/api/ficha/${nombre}`).then(r => r.json());
        
        // Actualizar UI
        document.getElementById('disp-nombre').innerText = nombre;
        document.getElementById('disp-raza').innerText = res.datos.raza;
        document.getElementById('disp-estado').innerText = res.datos.estado;
        document.getElementById('disp-iep').innerText = res.reproduccion.iep_dias;
        document.getElementById('disp-crias').innerText = res.reproduccion.cantidad_crias;
        
        // Cargar imagen .jpg por nombre exacto
        document.getElementById('foto-animal').src = `./imagenes/${res.datos.foto}`;
        
        cargarGrafica(nombre, 1); // Lactancia 1 por defecto
    }

    let miChart;
    async function cargarGrafica(nombre, lactancia) {
        const res = await fetch(`${API}/api/produccion/proyeccion/${nombre}/${lactancia}`).then(r => r.json());
        
        const ctx = document.getElementById('curvaLactancia').getContext('2d');
        if(miChart) miChart.destroy();
        
        miChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: res.historico.map(r => r.fecha),
                datasets: [{
                    label: `Lactancia ${lactancia} - Proyección 305d: ${res.proyeccion_total}L`,
                    data: res.historico.map(r => r.litros),
                    borderColor: '#22c55e',
                    tension: 0.3
                }]
            }
        });
    }
</script>
</body>
</html>
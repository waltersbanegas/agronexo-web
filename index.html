<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgroNexo V8 - Mapa H칤brido</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root { --p: #0f172a; --a: #22c55e; --bg: #f8fafc; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', sans-serif; }
        body { display:flex; height:100vh; overflow:hidden; background: var(--bg); }

        /* MENU LATERAL (PC) */
        .sidebar { 
            width:250px; background:var(--p); color:white; display:flex; flex-direction:column; 
            padding:15px; z-index:1000; flex-shrink:0; 
        }
        .logo { font-size:22px; font-weight:bold; color:var(--a); margin-bottom:25px; display:flex; gap:10px; align-items:center; }
        .btn-nav { 
            background:transparent; border:none; color:#cbd5e1; width:100%; padding:12px; text-align:left; 
            cursor:pointer; display:flex; gap:12px; border-radius:8px; margin-bottom:5px; font-size:15px; 
            align-items:center; transition:0.2s;
        }
        .btn-nav:hover, .btn-nav.active { background:#334155; color:white; border-left:4px solid var(--a); }
        .btn-nav i { width:20px; text-align:center; }

        /* AREA PRINCIPAL */
        .main { flex:1; position:relative; overflow:hidden; display:flex; flex-direction:column; }
        
        /* VISTAS */
        .view { flex:1; display:none; overflow-y:auto; padding:20px; position:relative; }
        .view.active { display:block; }
        
        /* ESTILO ESPECIAL PARA EL MAPA (Full Screen) */
        #mapa.view { padding:0; } /* El mapa ocupa todo */
        #map { width:100%; height:100%; }

        /* TARJETAS KPI */
        .grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:15px; margin-bottom:20px; }
        .card { background:white; padding:20px; border-radius:10px; border-top:4px solid var(--a); box-shadow:0 2px 5px rgba(0,0,0,0.05); }
        .card .num { font-size:32px; font-weight:bold; color:#1e293b; }
        .card .lbl { font-size:12px; color:#64748b; font-weight:bold; text-transform:uppercase; margin-bottom:5px; }

        /* TABLAS */
        .panel { background:white; border-radius:10px; padding:20px; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
        .panel-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
        .btn-action { background:var(--a); color:white; border:none; padding:8px 16px; border-radius:6px; font-weight:bold; cursor:pointer; }
        
        table { width:100%; border-collapse:collapse; font-size:14px; }
        th { text-align:left; background:#f1f5f9; padding:12px; color:#475569; border-bottom:2px solid #e2e8f0; }
        td { padding:12px; border-bottom:1px solid #e2e8f0; }

        /* M칍VIL (AJUSTES CR칈TICOS) */
        .mobile-bar { display:none; }
        
        @media (max-width: 768px) {
            body { flex-direction:column; }
            /* Sidebar se convierte en barra superior */
            .sidebar { 
                width:100%; height:60px; flex-direction:row; padding:0 10px; align-items:center; 
                justify-content:space-between; overflow:hidden;
            }
            .logo { font-size:18px; margin:0; }
            .btn-nav { display:none; } /* Ocultamos botones normales */
            
            /* Men칰 inferior para m칩vil */
            .mobile-bar { 
                display:flex; position:fixed; bottom:0; left:0; width:100%; height:60px; 
                background:white; border-top:1px solid #e2e8f0; z-index:2000; justify-content:space-around; align-items:center;
            }
            .mob-btn { 
                border:none; background:none; display:flex; flex-direction:column; align-items:center; 
                color:#64748b; font-size:10px; gap:4px; width:100%; padding:8px 0;
            }
            .mob-btn i { font-size:20px; }
            .mob-btn.active { color:var(--a); }
            
            .main { margin-bottom:60px; } /* Espacio para barra inferior */
            .view { padding:15px; }
        }

        /* MODALES */
        .overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; display:none; justify-content:center; align-items:center; }
        .modal { background:white; width:90%; max-width:400px; padding:25px; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,0.3); }
        .form-group { margin-bottom:15px; }
        .form-group label { display:block; font-size:13px; color:#64748b; margin-bottom:5px; }
        .form-input { width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px; font-size:16px; } /* Letra grande para m칩vil */
        .modal-btns { display:flex; justify-content:flex-end; gap:10px; margin-top:20px; }
        .btn-cancel { background:#e2e8f0; color:#475569; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; }

        /* Bot칩n Flotante (FAB) */
        .fab { position:fixed; bottom:80px; right:20px; width:56px; height:56px; background:var(--a); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px; box-shadow:0 4px 10px rgba(0,0,0,0.3); border:none; z-index:1500; cursor:pointer; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo"><i class="fas fa-leaf"></i> AgroNexo</div>
        <button class="btn-nav active" onclick="nav('home')"><i class="fas fa-home"></i> Inicio</button>
        <button class="btn-nav" onclick="nav('mapa')"><i class="fas fa-map-marked-alt"></i> Mapa H칤brido</button>
        <button class="btn-nav" onclick="nav('ganaderia')"><i class="fas fa-cow"></i> Ganader칤a</button>
        <button class="btn-nav" onclick="nav('agricultura')"><i class="fas fa-tractor"></i> Agricultura</button>
        <button class="btn-nav" onclick="nav('lluvia')"><i class="fas fa-cloud-showers-heavy"></i> Lluvias</button>
        <div style="flex:1"></div>
        <a href="https://agronexo-backend.onrender.com/reset" target="_blank" class="btn-nav" style="color:#ef4444"><i class="fas fa-trash"></i> Resetear Datos</a>
    </div>

    <div class="main">
        
        <div id="home" class="view active">
            <h2 style="margin-bottom:20px; color:#1e293b;">Resumen del Establecimiento</h2>
            <div class="grid">
                <div class="card"><div class="lbl">Hacienda</div><div class="num" id="k-ani">--</div></div>
                <div class="card"><div class="lbl">Lotes</div><div class="num" id="k-lot">--</div></div>
                <div class="card"><div class="lbl">Registros Lluvia</div><div class="num" id="k-llu">--</div></div>
            </div>
            <div class="panel">
                <p>游릭 Sistema conectado. Base de datos operativa.</p>
            </div>
        </div>

        <div id="mapa" class="view">
            <div id="map"></div>
        </div>

        <div id="ganaderia" class="view">
            <div class="panel">
                <div class="panel-head"><h3>Rodeo</h3><button class="btn-action pc-only" onclick="openM('m-ani')">+ Animal</button></div>
                <div style="overflow-x:auto"><table><thead><tr><th>Caravana</th><th>Cat</th><th>Estado</th></tr></thead><tbody id="t-ani"></tbody></table></div>
            </div>
            <button class="fab" onclick="openM('m-ani')">+</button>
        </div>

        <div id="agricultura" class="view">
            <div class="panel">
                <div class="panel-head"><h3>Lotes</h3><button class="btn-action pc-only" onclick="openM('m-lot')">+ Lote</button></div>
                <div style="overflow-x:auto"><table><thead><tr><th>Nombre</th><th>Cultivo</th><th>Has</th></tr></thead><tbody id="t-lot"></tbody></table></div>
            </div>
            <button class="fab" onclick="openM('m-lot')">+</button>
        </div>

        <div id="lluvia" class="view">
            <div class="panel">
                <div class="panel-head"><h3>Pluvi칩metro</h3><button class="btn-action pc-only" onclick="openM('m-llu')">+ Registro</button></div>
                <div style="overflow-x:auto"><table><thead><tr><th>Fecha</th><th>Mil칤metros</th></tr></thead><tbody id="t-llu"></tbody></table></div>
            </div>
            <button class="fab" onclick="openM('m-llu')">+</button>
        </div>

    </div>

    <div class="mobile-bar">
        <button class="mob-btn active" onclick="nav('home')"><i class="fas fa-home"></i>Inicio</button>
        <button class="mob-btn" onclick="nav('mapa')"><i class="fas fa-map"></i>Mapa</button>
        <button class="mob-btn" onclick="nav('ganaderia')"><i class="fas fa-cow"></i>Hacienda</button>
        <button class="mob-btn" onclick="nav('agricultura')"><i class="fas fa-tractor"></i>Lotes</button>
    </div>

    <div id="m-ani" class="overlay">
        <div class="modal">
            <h2>Nuevo Animal</h2>
            <div class="form-group"><label>Caravana</label><input id="i-ani-id" class="form-input" placeholder="Ej: RP-104"></div>
            <div class="form-group"><label>Categor칤a</label>
                <select id="i-ani-cat" class="form-input"><option>Vaca</option><option>Vaquillona</option><option>Ternero</option><option>Toro</option></select>
            </div>
            <div class="form-group"><label>Estado Reproductivo</label>
                <select id="i-ani-est" class="form-input"><option>VACIA</option><option>PRE칌ADA</option><option>PARIDA</option></select>
            </div>
            <div class="modal-btns"><button class="btn-cancel" onclick="closeM()">Cancelar</button><button class="btn-action" onclick="save('ganaderia')">Guardar</button></div>
        </div>
    </div>

    <div id="m-lot" class="overlay">
        <div class="modal">
            <h2>Nuevo Lote</h2>
            <div class="form-group"><label>Nombre</label><input id="i-lot-nom" class="form-input" placeholder="Ej: Lote Norte"></div>
            <div class="form-group"><label>Cultivo</label>
                <select id="i-lot-cul" class="form-input"><option>Soja</option><option>Ma칤z</option><option>Girasol</option><option>Sorgo</option><option>Barbecho</option></select>
            </div>
            <div class="form-group"><label>Hect치reas</label><input type="number" id="i-lot-has" class="form-input"></div>
            <div class="modal-btns"><button class="btn-cancel" onclick="closeM()">Cancelar</button><button class="btn-action" onclick="save('agricultura')">Guardar</button></div>
        </div>
    </div>

    <div id="m-llu" class="overlay">
        <div class="modal">
            <h2>Registrar Lluvia</h2>
            <div class="form-group"><label>Mil칤metros (mm)</label><input type="number" id="i-llu-mm" class="form-input"></div>
            <div class="modal-btns"><button class="btn-cancel" onclick="closeM()">Cancelar</button><button class="btn-action" onclick="save('lluvia')">Guardar</button></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API = "https://agronexo-backend.onrender.com";
        let map;

        window.onload = init;

        function nav(id) {
            // Activar Vistas
            document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            // Activar Botones (PC y M칩vil)
            document.querySelectorAll('.btn-nav, .mob-btn').forEach(e => e.classList.remove('active'));
            // Busca los botones que llaman a esta funcion y act칤valos (simplificado)
            
            if(id === 'mapa' && map) setTimeout(() => map.invalidateSize(), 200);
        }

        async function init() {
            // Cargar KPIs
            fetch(`${API}/api/resumen`).then(r=>r.json()).then(d=>{
                document.getElementById('k-ani').innerText = d.animales;
                document.getElementById('k-lot').innerText = d.lotes;
                document.getElementById('k-llu').innerText = d.lluvias;
            });
            
            // Cargar Tablas
            fillT('ganaderia', 't-ani', x=>`<td><b>${x.caravana}</b></td><td>${x.categoria}</td><td>${x.estado}</td>`);
            fillT('agricultura', 't-lot', x=>`<td>${x.nombre}</td><td>${x.cultivo}</td><td>${x.hectareas} Has</td>`);
            fillT('lluvia', 't-llu', x=>`<td>${x.fecha}</td><td><b>${x.mm} mm</b></td>`);

            // INICIAR MAPA H칈BRIDO (GOOGLE)
            if(!map) {
                map = L.map('map').setView([-26.70, -60.80], 13);
                
                // CAPA GOOGLE HYBRID (Sat칠lite + Nombres)
                L.tileLayer('http://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{
                    maxZoom: 20,
                    subdomains:['mt0','mt1','mt2','mt3']
                }).addTo(map);
            }

            // Cargar Puntos en Mapa
            const pts = await (await fetch(`${API}/api/mapa`)).json();
            pts.forEach(p => {
                const color = p.color=='red'?'#ef4444':(p.color=='green'?'#22c55e':'#3b82f6');
                L.circleMarker([p.lat, p.lng], {
                    radius: 8, fillColor: color, color: "white", weight: 2, fillOpacity: 1
                })
                .addTo(map)
                .bindTooltip(`<b>${p.titulo}</b>`, {permanent:true, direction:'bottom', className: 'map-label'})
                .bindPopup(`<b>${p.titulo}</b><br>${p.desc}`);
            });
        }

        async function fillT(ep, id, fn) {
            const data = await (await fetch(`${API}/api/${ep}`)).json();
            document.getElementById(id).innerHTML = data.map(x => `<tr>${fn(x)}</tr>`).join('');
        }

        // Modales
        function openM(id) { document.getElementById(id).style.display = 'flex'; }
        function closeM() { document.querySelectorAll('.overlay').forEach(e => e.style.display='none'); }

        // Guardar Datos
        async function save(type) {
            let data = {};
            if(type==='ganaderia') {
                data = {
                    caravana: document.getElementById('i-ani-id').value,
                    categoria: document.getElementById('i-ani-cat').value,
                    estado: document.getElementById('i-ani-est').value,
                    lat: -26.70 - Math.random()/100, lng: -60.80 - Math.random()/100 // Ubicaci칩n simulada cerca
                };
            } else if(type==='agricultura') {
                data = {
                    nombre: document.getElementById('i-lot-nom').value,
                    cultivo: document.getElementById('i-lot-cul').value,
                    has: document.getElementById('i-lot-has').value,
                    lat: -26.705, lng: -60.805
                };
            } else if(type==='lluvia') {
                data = { mm: document.getElementById('i-llu-mm').value };
            }

            await fetch(`${API}/api/${type}`, {
                method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)
            });
            closeM(); alert('Guardado!'); init();
        }
    </script>
</body>
</html>
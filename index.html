<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgroNexo ERP Expert</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --p: #0f172a; --a: #22c55e; --bg: #f8fafc; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:sans-serif; }
        body { display:flex; height:100vh; overflow:hidden; background:var(--bg); }
        .sidebar { width:260px; background:var(--p); color:white; padding:15px; display:flex; flex-direction:column; z-index:1000; }
        .logo { font-size:22px; font-weight:bold; color:var(--a); margin-bottom:30px; }
        .nav-btn { background:none; border:none; color:#cbd5e1; width:100%; padding:12px; text-align:left; cursor:pointer; display:flex; gap:10px; border-radius:8px; margin-bottom:5px; }
        .nav-btn.active, .nav-btn:hover { background:#334155; color:white; border-left:4px solid var(--a); }
        .main { flex:1; overflow-y:auto; padding:15px; position:relative; }
        .view { display:none; }
        .view.active { display:block; animation:fadeIn 0.3s; }
        .grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:15px; margin-bottom:20px; }
        .card { background:white; padding:20px; border-radius:12px; border-top:4px solid var(--a); box-shadow:0 4px 6px rgba(0,0,0,0.05); }
        #map { width:100%; height:70vh; border-radius:12px; }
        @media (max-width:768px) { body{flex-direction:column;} .sidebar{width:100%; height:auto; flex-direction:row; overflow-x:auto; white-space:nowrap;} .logo{display:none;} }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="logo">AgroNexo</div>
    <button class="nav-btn active" onclick="go('dash')"><i class="fas fa-home"></i> Dashboard</button>
    <button class="nav-btn" onclick="go('mapa')"><i class="fas fa-map"></i> Mapa</button>
    <button class="nav-btn" onclick="go('ganaderia')"><i class="fas fa-cow"></i> Ganadería</button>
    <button class="nav-btn" onclick="go('agricultura')"><i class="fas fa-seedling"></i> Lotes</button>
    <button class="nav-btn" onclick="go('lluvia')"><i class="fas fa-cloud-rain"></i> Lluvia</button>
    <button class="nav-btn" onclick="go('repo')"><i class="fas fa-file-export"></i> Reportes</button>
</div>

<div class="main">
    <div id="dash" class="view active">
        <div class="grid">
            <div class="card"><h3>Caja Neta</h3><div id="k-caja" style="font-size:24px; font-weight:bold;">$ --</div></div>
            <div class="card"><h3>Hacienda</h3><div id="k-ani" style="font-size:24px; font-weight:bold;">--</div></div>
            <div class="card"><h3>Lotes</h3><div id="k-lot" style="font-size:24px; font-weight:bold;">--</div></div>
        </div>
        <div class="card"><h3>Clima Real: Los Frentones</h3><div id="w-temp" style="font-size:32px;">--°C</div></div>
    </div>
    <div id="mapa" class="view"><div id="map"></div></div>
    <div id="ganaderia" class="view"><div class="card"><h2>Gestión Braford</h2><div id="t-vaca">Cargando...</div></div></div>
    <div id="agricultura" class="view"><div class="card"><h2>Lotes y Alquileres</h2><div id="t-lot">Cargando...</div></div></div>
    <div id="lluvia" class="view"><div class="card"><h2>Pluviómetro</h2><div id="t-rain">Cargando...</div></div></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const API = "https://agronexo-backend.onrender.com";
    let map;

    function go(id){
        document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id==='mapa') setTimeout(initMap, 200);
    }

    async function loadAll(){
        const r = await (await fetch(`${API}/api/dashboard/full`)).json();
        document.getElementById('k-caja').innerText = `$ ${r.finanzas.caja.toLocaleString()}`;
        document.getElementById('k-ani').innerText = r.produccion.animales;
        document.getElementById('k-lot').innerText = r.produccion.lotes;
        
        // Clima Real
        fetch('https://api.open-meteo.com/v1/forecast?latitude=-26.42&longitude=-61.41&current_weather=true')
            .then(res => res.json()).then(w => document.getElementById('w-temp').innerText = `${w.current_weather.temperature}°C`);
    }

    function initMap(){
        if(!map){
            map = L.map('map').setView([-26.42, -61.41], 13);
            L.tileLayer('http://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{maxZoom:20, subdomains:['mt0','mt1','mt2','mt3']}).addTo(map);
        }
    }

    window.onload = loadAll;
</script>
</body>
</html>
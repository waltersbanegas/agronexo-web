<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgroNexo Full</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root { --primary: #0f172a; --accent: #22c55e; --bg: #f1f5f9; --text: #1e293b; }
        * { box-sizing: border_box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        
        body { background: var(--bg); display: flex; height: 100vh; overflow: hidden; }

        /* --- SIDEBAR (Barra Lateral) --- */
        .sidebar { 
            width: 240px; background: var(--primary); color: white; display: flex; flex-direction: column; 
            padding: 15px; flex-shrink: 0; z-index: 1000;
        }
        .logo { font-size: 20px; font-weight: bold; color: var(--accent); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        
        .nav-btn {
            background: transparent; border: none; color: #cbd5e1; width: 100%; padding: 12px; text-align: left;
            font-size: 14px; cursor: pointer; border-radius: 8px; display: flex; align-items: center; gap: 10px;
            margin-bottom: 4px; transition: 0.2s;
        }
        .nav-btn:hover, .nav-btn.active { background: #334155; color: white; border-left: 4px solid var(--accent); }

        /* --- MAIN (Contenido) --- */
        .main { flex: 1; padding: 15px; overflow-y: auto; position: relative; }

        /* --- PANELES --- */
        .panel { display: none; }
        .panel.active { display: block; animation: fadeIn 0.3s; }
        
        /* Dashboard */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-top: 3px solid var(--accent); }
        .card h3 { font-size: 11px; color: #64748b; text-transform: uppercase; margin: 0 0 5px 0; }
        .card .val { font-size: 24px; font-weight: bold; color: var(--text); }

        /* Tablas */
        .table-box { background: white; border-radius: 8px; padding: 15px; overflow-x: auto; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 300px; font-size: 13px; }
        th { text-align: left; background: #f8fafc; padding: 10px; color: #64748b; }
        td { padding: 10px; border-bottom: 1px solid #e2e8f0; }

        /* Botón Flotante para Móvil */
        .fab { position: fixed; bottom: 20px; right: 20px; background: var(--accent); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 2000; border: none; }

        /* Mapa */
        #map { height: 75vh; width: 100%; border-radius: 8px; }
        .leaflet-tooltip { font-weight: bold; border: none; box-shadow: none; background: rgba(255,255,255,0.8); }

        /* --- MÓVIL (SOLUCIÓN PANTALLA CORTADA) --- */
        @media (max-width: 768px) {
            body { flex-direction: column; } /* Cambia a vertical */
            .sidebar { 
                width: 100%; height: auto; flex-direction: row; overflow-x: auto; padding: 10px; 
                align-items: center; background: var(--primary); flex-shrink: 0; white-space: nowrap;
            }
            .logo { display: none; } /* Ocultar logo en móvil */
            .nav-btn { 
                width: auto; padding: 6px 12px; font-size: 12px; margin: 0 5px; 
                border-left: none; border-bottom: 2px solid transparent; flex-direction: column; gap: 4px;
            }
            .nav-btn.active { border-left: none; border-bottom: 2px solid var(--accent); }
            .nav-btn i { font-size: 16px; }
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo"><i class="fas fa-leaf"></i> AgroNexo</div>
        <button class="nav-btn active" onclick="nav('home')"><i class="fas fa-home"></i> Inicio</button>
        <button class="nav-btn" onclick="nav('mapa')"><i class="fas fa-map"></i> Mapa</button>
        <button class="nav-btn" onclick="nav('ganaderia')"><i class="fas fa-cow"></i> Ganadería</button>
        <button class="nav-btn" onclick="nav('agricultura')"><i class="fas fa-tractor"></i> Agricultura</button>
        <button class="nav-btn" onclick="nav('lluvia')"><i class="fas fa-cloud-showers-heavy"></i> Lluvia</button>
        <div style="flex:1"></div>
        <a href="https://agronexo-backend.onrender.com/reset" target="_blank" class="nav-btn" style="color:#ef4444"><i class="fas fa-sync"></i> Reset</a>
    </div>

    <div class="main">
        
        <div id="home" class="panel active">
            <h2 style="margin-bottom:15px">Resumen General</h2>
            <div class="kpi-grid">
                <div class="card"><h3>Hacienda</h3><div class="val" id="kpi-animales">--</div></div>
                <div class="card"><h3>Lotes</h3><div class="val" id="kpi-lotes">--</div></div>
                <div class="card"><h3>Lluvia (Reg)</h3><div class="val" id="kpi-lluvias">--</div></div>
            </div>
            <div class="table-box">
                <p>Sistema Operativo v6.0 - Conexión Satelital Activa</p>
            </div>
        </div>

        <div id="mapa" class="panel">
            <div id="map"></div>
        </div>

        <div id="ganaderia" class="panel">
            <h2 style="margin-bottom:10px">Rodeo</h2>
            <div class="table-box">
                <table>
                    <thead><tr><th>Caravana</th><th>Cat</th><th>Estado</th></tr></thead>
                    <tbody id="list-ganaderia"></tbody>
                </table>
            </div>
            <button class="fab" onclick="addAnimal()">+</button>
        </div>

        <div id="agricultura" class="panel">
            <h2 style="margin-bottom:10px">Lotes</h2>
            <div class="table-box">
                <table><thead><tr><th>Nombre</th><th>Cultivo</th><th>Has</th></tr></thead><tbody id="list-agricultura"></tbody></table>
            </div>
            <button class="fab" onclick="addLote()">+</button>
        </div>

        <div id="lluvia" class="panel">
            <h2 style="margin-bottom:10px">Pluviómetro</h2>
            <div class="table-box">
                <table><thead><tr><th>Fecha</th><th>Milímetros</th></tr></thead><tbody id="list-lluvia"></tbody></table>
            </div>
            <button class="fab" onclick="addLluvia()">+</button>
        </div>

    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API = "https://agronexo-backend.onrender.com";
        let map = null;

        // Iniciar
        window.onload = loadData;

        // Navegación
        function nav(id) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');

            if(id === 'mapa') {
                setTimeout(() => {
                    if(!map) initMap();
                    map.invalidateSize(); // ARREGLA EL GRIS
                }, 100);
            }
        }

        // Cargar Datos
        async function loadData() {
            try {
                // Resumen
                const res = await fetch(`${API}/api/resumen`);
                const data = await res.json();
                document.getElementById('kpi-animales').innerText = data.animales;
                document.getElementById('kpi-lotes').innerText = data.lotes;
                document.getElementById('kpi-lluvias').innerText = data.lluvias;

                // Tablas
                loadTable('ganaderia', 'list-ganaderia', i => `<td><b>${i.caravana}</b></td><td>${i.categoria}</td><td>${i.estado}</td>`);
                loadTable('agricultura', 'list-agricultura', i => `<td>${i.nombre}</td><td>${i.cultivo}</td><td>${i.hectareas}</td>`);
                loadTable('lluvia', 'list-lluvia', i => `<td>${i.fecha}</td><td><b>${i.mm} mm</b></td>`);
                
            } catch(e) { console.log("Cargando..."); }
        }

        async function loadTable(ep, id, fmt) {
            const res = await fetch(`${API}/api/${ep}`);
            const list = await res.json();
            const tbody = document.getElementById(id);
            tbody.innerHTML = '';
            list.forEach(i => tbody.innerHTML += `<tr>${fmt(i)}</tr>`);
        }

        // Mapa
        async function initMap() {
            map = L.map('map').setView([-26.70, -60.80], 14);
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);

            const res = await fetch(`${API}/api/mapa`);
            const pts = await res.json();
            
            pts.forEach(p => {
                const color = p.color === 'red' ? '#ef4444' : (p.color === 'green' ? '#22c55e' : '#3b82f6');
                L.circleMarker([p.lat, p.lng], {
                    radius: 8, fillColor: color, color: "#fff", weight: 2, fillOpacity: 1
                })
                .addTo(map)
                .bindTooltip(p.titulo, {permanent: true, direction: 'bottom', offset: [0, 5]}) // ETIQUETA PERMANENTE
                .bindPopup(`<b>${p.titulo}</b><br>${p.desc}`);
            });
        }

        // Acciones Rápidas
        async function addAnimal() {
            const id = prompt("Nro Caravana:");
            if(id) post('ganaderia', {caravana:id, categoria:'Vaca', lat:-26.7-Math.random()/100, lng:-60.8-Math.random()/100});
        }
        async function addLote() {
            const nom = prompt("Nombre Lote:");
            if(nom) post('agricultura', {nombre:nom, cultivo:'Soja', hectareas:100, lat:-26.7-Math.random()/100, lng:-60.8-Math.random()/100});
        }
        async function addLluvia() {
            const mm = prompt("Milímetros Caídos:");
            if(mm) post('lluvia', {mm:mm, notas:'Manual'});
        }

        async function post(ep, data) {
            await fetch(`${API}/api/${ep}`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
            alert("Guardado");
            loadData();
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgroNexo Expert V9</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --p: #0f172a; --a: #22c55e; --bg: #f8fafc; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',sans-serif; }
        body { display:flex; height:100vh; background:var(--bg); overflow:hidden; }
        .sidebar { width:260px; background:var(--p); color:white; padding:20px; display:flex; flex-direction:column; z-index:1000; }
        .logo { font-size:24px; font-weight:bold; color:var(--a); margin-bottom:40px; }
        .nav-btn { background:none; border:none; color:#cbd5e1; width:100%; padding:15px; text-align:left; cursor:pointer; display:flex; gap:12px; border-radius:8px; margin-bottom:5px; }
        .nav-btn.active, .nav-btn:hover { background:#334155; color:white; border-left:4px solid var(--a); }
        .main { flex:1; padding:25px; overflow-y:auto; position:relative; }
        .view { display:none; animation:fadeIn 0.3s; }
        .view.active { display:block; }
        .grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:20px; margin-bottom:20px; }
        .card { background:white; padding:25px; border-radius:12px; border-top:5px solid var(--a); box-shadow:0 4px 6px rgba(0,0,0,0.05); }
        .card .val { font-size:32px; font-weight:bold; color:var(--p); }
        #map { width:100%; height:70vh; border-radius:12px; }
        @media (max-width:768px) { body{flex-direction:column;} .sidebar{width:100%; height:auto; flex-direction:row; overflow-x:auto;} .logo{display:none;} }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="logo">AgroNexo</div>
    <button class="nav-btn active" onclick="go('dash')"><i class="fas fa-home"></i> Dashboard</button>
    <button class="nav-btn" onclick="go('mapa')"><i class="fas fa-map-marked-alt"></i> Mapa Híbrido</button>
    <button class="nav-btn" onclick="go('vaca')"><i class="fas fa-cow"></i> Ganadería</button>
    <button class="nav-btn" onclick="go('repo')"><i class="fas fa-file-export"></i> Reportes</button>
    <div style="flex:1"></div>
    <div id="sync-status" style="font-size:11px; padding:10px; color:#aaa;">Sincronizado ✅</div>
</div>

<div class="main">
    <div id="dash" class="view active">
        <div class="grid">
            <div class="card"><h3>Caja Neta</h3><div class="val" id="k-caja">$ --</div></div>
            <div class="card"><h3>Hacienda</h3><div class="val" id="k-ani">--</div></div>
            <div class="card"><h3>GDP Promedio</h3><div class="val">0.850 kg/d</div></div>
        </div>
    </div>
    <div id="mapa" class="view"><div id="map"></div></div>
    <div id="vaca" class="view">
        <div class="card">
            <h2>Manejo Individual (Braford)</h2>
            <table style="width:100%; margin-top:20px; border-collapse:collapse;">
                <thead><tr style="text-align:left;"><th>ID</th><th>Raza</th><th>Peso</th><th>Estado</th></tr></thead>
                <tbody id="t-vaca"></tbody>
            </table>
        </div>
    </div>
    <div id="repo" class="view">
        <div class="card">
            <h2>Exportar Gestión</h2>
            <div style="margin-top:20px; display:flex; gap:15px;">
                <button class="nav-btn" style="background:#1d6f42; color:white; width:auto;" onclick="expXL()">Excel</button>
                <button class="nav-btn" style="background:#b91c1c; color:white; width:auto;" onclick="expPDF()">PDF</button>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const API = "https://agronexo-backend.onrender.com";
    let map;

    function go(id){
        document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id==='mapa') setTimeout(initMap, 200);
    }

    async function load(){
        const r = await (await fetch(`${API}/api/dashboard`)).json();
        document.getElementById('k-caja').innerText = `$ ${r.finanzas.caja.toLocaleString()}`;
        document.getElementById('k-ani').innerText = r.produccion.animales;
    }

    function initMap(){
        if(!map){
            map = L.map('map').setView([-26.42, -61.41], 13);
            L.tileLayer('http://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{maxZoom:20, subdomains:['mt0','mt1','mt2','mt3']}).addTo(map);
        }
        map.invalidateSize();
    }

    window.onload = load;
</script>
</body>
</html>